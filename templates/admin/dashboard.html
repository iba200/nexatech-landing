{% extends 'base.html' %}

{% block title %}Dashboard Admin - NexaTech{% endblock %}

{% block content %}
<!-- Header -->
<section class="bg-gray-900 text-white py-6 md:py-12">
    <div class="container mx-auto px-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold">Dashboard</h1>
            <p class="text-blue-200 text-sm md:text-base">Bienvenue, Administrateur</p>
        </div>
        <a href="{{ url_for('admin_logout') }}"
            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition font-medium text-sm w-full sm:w-auto text-center">
            D√©connexion
        </a>
    </div>
</section>

<section class="py-6 md:py-12 bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4">

        <!-- Search & Filter Bar -->
        <div class="mb-6 bg-white p-3 md:p-4 rounded-xl shadow-sm border border-gray-100">
            <form action="{{ url_for('admin_dashboard') }}" method="GET"
                class="space-y-3 md:space-y-0 md:flex md:gap-4">
                <!-- Search Input -->
                <div class="relative flex-grow">
                    <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <input type="text" name="q" placeholder="Rechercher..." value="{{ query }}"
                        class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-blue-500 outline-none text-base">
                </div>

                <!-- Filter Dropdown -->
                <select name="type" onchange="this.form.submit()"
                    class="w-full md:w-48 px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-blue-500 outline-none bg-white text-base">
                    <option value="">Tous les projets</option>
                    <option value="website" {% if current_type=='website' %}selected{% endif %}>Site Web</option>
                    <option value="webapp" {% if current_type=='webapp' %}selected{% endif %}>App Web</option>
                    <option value="saas" {% if current_type=='saas' %}selected{% endif %}>SaaS</option>
                    <option value="maintenance" {% if current_type=='maintenance' %}selected{% endif %}>Maintenance
                    </option>
                    <option value="immogest" {% if current_type=='immogest' %}selected{% endif %}>Immogest</option>
                    <option value="other" {% if current_type=='other' %}selected{% endif %}>Autre</option>
                </select>

                <div class="flex gap-2">
                    <button type="submit"
                        class="flex-1 md:flex-none bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition">
                        Filtrer
                    </button>
                    {% if query or current_type %}
                    <a href="{{ url_for('admin_dashboard') }}"
                        class="flex-1 md:flex-none flex items-center justify-center px-4 py-3 text-gray-500 bg-gray-100 hover:bg-gray-200 rounded-lg transition">
                        R√©initialiser
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>

        <!-- Tabs -->
        <div class="flex overflow-x-auto mb-6 border-b border-gray-200 pb-1 -mx-4 px-4 md:mx-0 md:px-0">
            <button onclick="switchTab('contacts')" id="tab-contacts"
                class="flex-shrink-0 px-4 md:px-6 py-3 font-bold text-blue-600 border-b-2 border-blue-600 transition text-sm md:text-base whitespace-nowrap">
                Contacts ({{ contacts.total }})
            </button>
            <button onclick="switchTab('signups')" id="tab-signups"
                class="flex-shrink-0 px-4 md:px-6 py-3 font-bold text-gray-500 hover:text-blue-600 transition text-sm md:text-base whitespace-nowrap">
                Beta Immogest ({{ signups.total }})
            </button>
        </div>

        <!-- Contacts Content -->
        <div id="content-contacts" class="space-y-4">
            {% if contacts.items %}

            <!-- Desktop Table (hidden on mobile) -->
            <div class="hidden md:block bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 text-gray-600 text-sm uppercase tracking-wider border-b">
                                <th class="p-4 font-semibold">Date</th>
                                <th class="p-4 font-semibold">Nom</th>
                                <th class="p-4 font-semibold">Contact</th>
                                <th class="p-4 font-semibold">Soci√©t√© / Projet</th>
                                <th class="p-4 font-semibold">Budget</th>
                                <th class="p-4 font-semibold">Message</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            {% for c in contacts.items %}
                            <tr class="hover:bg-blue-50/50 transition">
                                <td class="p-4 text-sm text-gray-500 whitespace-nowrap">{{
                                    c.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                                <td class="p-4 font-medium text-gray-900">{{ c.name }}</td>
                                <td class="p-4 text-sm">
                                    <div class="text-gray-900">{{ c.email }}</div>
                                    {% if c.phone %}<div class="text-gray-500">{{ c.phone }}</div>{% endif %}
                                </td>
                                <td class="p-4 text-sm">
                                    {% if c.company %}<div class="font-medium text-gray-900">{{ c.company }}</div>{%
                                    endif %}
                                    <span
                                        class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded mt-1">{{
                                        c.project_type }}</span>
                                </td>
                                <td class="p-4 text-sm text-gray-600">{{ c.budget }}</td>
                                <td class="p-4 text-sm text-gray-600 max-w-xs truncate" title="{{ c.message }}">{{
                                    c.message }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Mobile Cards (hidden on desktop) -->
            <div class="md:hidden space-y-3">
                {% for c in contacts.items %}
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-bold text-gray-900">{{ c.name }}</h3>
                            <p class="text-sm text-gray-500">{{ c.created_at.strftime('%d/%m/%Y %H:%M') }}</p>
                        </div>
                        <span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded">{{ c.project_type
                            }}</span>
                    </div>

                    <div class="space-y-2 text-sm">
                        <div class="flex items-center gap-2">
                            <span class="text-gray-400">üìß</span>
                            <a href="mailto:{{ c.email }}" class="text-blue-600">{{ c.email }}</a>
                        </div>
                        {% if c.phone %}
                        <div class="flex items-center gap-2">
                            <span class="text-gray-400">üì±</span>
                            <a href="tel:{{ c.phone }}" class="text-gray-700">{{ c.phone }}</a>
                        </div>
                        {% endif %}
                        {% if c.company %}
                        <div class="flex items-center gap-2">
                            <span class="text-gray-400">üè¢</span>
                            <span class="text-gray-700">{{ c.company }}</span>
                        </div>
                        {% endif %}
                        <div class="flex items-center gap-2">
                            <span class="text-gray-400">üí∞</span>
                            <span class="text-gray-700">{{ c.budget }}</span>
                        </div>
                    </div>

                    {% if c.message %}
                    <div class="mt-3 pt-3 border-t border-gray-100">
                        <p class="text-sm text-gray-600 line-clamp-2">{{ c.message }}</p>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if contacts.pages > 1 %}
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                    <p class="text-sm text-gray-600 text-center sm:text-left">
                        <span class="font-medium">{{ ((contacts.page - 1) * contacts.per_page) + 1 }}</span> -
                        <span class="font-medium">{{ ((contacts.page - 1) * contacts.per_page) + contacts.items|length
                            }}</span> sur
                        <span class="font-medium">{{ contacts.total }}</span>
                    </p>
                    <div class="flex gap-2">
                        {% if contacts.has_prev %}
                        <a href="{{ url_for('admin_dashboard', page=contacts.prev_num, q=query, type=current_type) }}"
                            class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                            ‚Üê Pr√©c√©dent
                        </a>
                        {% endif %}
                        {% if contacts.has_next %}
                        <a href="{{ url_for('admin_dashboard', page=contacts.next_num, q=query, type=current_type) }}"
                            class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                            Suivant ‚Üí
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            {% else %}
            <div class="text-center py-16 bg-white rounded-xl shadow-sm">
                <div class="text-4xl mb-4">üì≠</div>
                <p class="text-gray-500 text-lg">Aucun message.</p>
            </div>
            {% endif %}
        </div>

        <!-- Beta Signups Content -->
        <div id="content-signups" class="hidden space-y-4">
            {% if signups.items %}

            <!-- Desktop Table (hidden on mobile) -->
            <div class="hidden md:block bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-50 text-gray-600 text-sm uppercase tracking-wider border-b">
                            <th class="p-4 font-semibold">Date</th>
                            <th class="p-4 font-semibold">Email</th>
                            <th class="p-4 font-semibold">Propri√©t√©s</th>
                            <th class="p-4 font-semibold">Status</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        {% for s in signups.items %}
                        <tr class="hover:bg-orange-50/50 transition">
                            <td class="p-4 text-sm text-gray-500 whitespace-nowrap">{{ s.created_at.strftime('%d/%m/%Y
                                %H:%M') }}</td>
                            <td class="p-4 font-medium text-gray-900">{{ s.email }}</td>
                            <td class="p-4 text-sm text-gray-900">{{ s.properties }}</td>
                            <td class="p-4">
                                <span class="bg-yellow-100 text-yellow-800 text-xs font-bold px-2 py-1 rounded">En
                                    attente</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Mobile Cards (hidden on desktop) -->
            <div class="md:hidden space-y-3">
                {% for s in signups.items %}
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="font-bold text-gray-900 break-all">{{ s.email }}</p>
                            <p class="text-sm text-gray-500">{{ s.created_at.strftime('%d/%m/%Y %H:%M') }}</p>
                        </div>
                        <span
                            class="bg-yellow-100 text-yellow-800 text-xs font-bold px-2 py-1 rounded flex-shrink-0 ml-2">En
                            attente</span>
                    </div>
                    <div class="text-sm text-gray-600">
                        <span class="text-gray-400">üè†</span> {{ s.properties }} propri√©t√©(s)
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if signups.pages > 1 %}
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                <div class="flex justify-between">
                    {% if signups.has_prev %}
                    <a href="{{ url_for('admin_dashboard', page=signups.prev_num, q=query) }}"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        ‚Üê Pr√©c√©dent
                    </a>
                    {% else %}
                    <span></span>
                    {% endif %}
                    {% if signups.has_next %}
                    <a href="{{ url_for('admin_dashboard', page=signups.next_num, q=query) }}"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        Suivant ‚Üí
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% else %}
            <div class="text-center py-16 bg-white rounded-xl shadow-sm">
                <div class="text-4xl mb-4">üì≠</div>
                <p class="text-gray-500 text-lg">Aucune inscription.</p>
            </div>
            {% endif %}
        </div>

    </div>
</section>

<script>
    function switchTab(tabName) {
        document.getElementById('content-contacts').classList.add('hidden');
        document.getElementById('content-signups').classList.add('hidden');

        document.getElementById('tab-contacts').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
        document.getElementById('tab-contacts').classList.add('text-gray-500');

        document.getElementById('tab-signups').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
        document.getElementById('tab-signups').classList.add('text-gray-500');

        document.getElementById('content-' + tabName).classList.remove('hidden');

        const btn = document.getElementById('tab-' + tabName);
        btn.classList.remove('text-gray-500');
        btn.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
    }
</script>
{% endblock %}